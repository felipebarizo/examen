```{r}
library(tidyverse)
library(srvyr)
library(haven)
library(dplyr)
library(srvyr)
library(here)
library(readxl)

s <- read_sav("C:/Users/Usuario/Downloads/P_2019_Terceros.sav")


s = s %>% filter(dpto != 1) |> transmute(
numero,
nper,
dpto,
sexo = e26,
edad = e27,
ingreso = PT1,
ocupado = case_when(pobpcoac == 2 ~ 1, TRUE ~ 0),
desocupado = case_when(pobpcoac >= 3 & pobpcoac <= 5 ~ 1, TRUE ~ 0),
pet = case_when(edad >= 14 ~ 1, TRUE ~ 0),
activo = ocupado + desocupado,
pobreza = as.numeric(pobre06),
w = pesoano
)
info_design = read_sav(here("HW3",'ESTRATO_UPM_ECH2019.sav'))
s = s |> left_join(info_design)

s


design_srvyr <- s %>% as_survey_design(ids = upm_fic,strata = estrato,weights = w,nest = TRUE)

tasa_desempleo <- design_srvyr |> summarise(tasa_des = survey_ratio(desocupado,activo, vartype = c("ci","cv"),level = 0.95))
tasa_desempleo
```

```{r}
tasa_desempleo_por_dpto <- design_srvyr|> group_by(dpto) |> summarise(tasa_des_por_dpto = survey_ratio(desocupado,activo, vartype = c("ci","cv"),level = 0.95))
tasa_desempleo_por_dpto

"Lo que indica una mejor situación laboral relativa.

2. Interpretación de los intervalos de confianza
Los intervalos son relativamente estrechos en la mayoría de departamentos, lo que indica estimaciones confiables.

Por ejemplo, en el departamento 6, la tasa está entre 13.5% y 19%, con un CV que probablemente esté dentro del rango aceptable.

Algunos departamentos (como el 7) tienen IC más amplios, probablemente por un tamaño de muestra menor o mayor variabilidad.

3. Comparaciones entre departamentos
Los departamentos con tasas altas indican mayor dificultad para insertarse en el mercado laboral.

Las diferencias en tasas pueden reflejar factores estructurales, económicos o sociales regionales.

Podrías investigar por qué, por ejemplo, el departamento 6 tiene una tasa tan alta, analizando variables locales o características específicas.

4. Recomendaciones
Presentar estos resultados a los tomadores de decisión para priorizar políticas laborales en departamentos con tasas elevadas.

Si se tienen datos adicionales, analizar correlaciones con educación, actividad económica, etc.

Complementar con mapas o gráficos para visualizar la distribución geográfica."
```

```{r}
prop_pobreza <- design_srvyr|>filter(!is.na(pobreza)) |> summarise(linea_pobreza = survey_mean(pobreza,vartype = c("ci","cv"),level = 0.95))
prop_pobreza_dpto <- design_srvyr|> group_by(dpto) |> summarise(linea_pobreza_dpto = survey_mean(pobreza,vartype = c("ci","cv"),level = 0.95))
prop_pobreza
prop_pobreza_dpto

```

```{r}
ingreso_prom_dpto_mujeres <- design_srvyr |> filter(sexo == 2,edad >= 35, edad <= 45) |> group_by(dpto) |>
summarise(ingreso_prom_dpto_mujeres = survey_mean(ingreso,vartype = c("ci","cv"),level = 0.95))  
ingreso_prom_dpto_mujeres

ingreso_prom_dpto_mujeres <- ingreso_prom_dpto_mujeres %>%
  mutate(
    confiable = ifelse(cv > 0.20, "Sí", "No")
  )

ingreso_prom_dpto_mujeres
```

```{r}
prop_desoc <- design_srvyr |>   filter(edad >= 14) %>%
  mutate(
    tramo_edad = case_when(
      edad >= 14 & edad <= 24 ~ "14-24",
      edad >= 25 & edad <= 34 ~ "25-34",
      edad >= 35 & edad <= 49 ~ "35-49",
      edad >= 50            ~ "50+"
    )
  ) |> group_by(tramo_edad) |> summarise(prop_desocup = survey_mean(desocupado, vartype = c("ci", "cv"),level = 0.95))

ggplot(prop_desoc, aes(x = tramo_edad, y = prop_desocup, group = 1)) +
  geom_point(size = 3, color = "blue") +
  geom_errorbar(aes(ymin = prop_desocup_low, ymax = prop_desocup_upp), width = 0.2, color = "blue") +
  labs(
    title = "Proporción de desocupados por tramo de edad",
    x = "Tramo de edad",
    y = "Proporción desocupados"
  ) +
  theme_minimal()

```

```{r}
tot_mayores_18 <- design_srvyr |> filter(edad >= 18)|> group_by(dpto) |>survey_count(vartype = c("ci", "cv"),level = 0.95)
tot_mayores_18

"
Canelones:
Aproximadamente 480.000 personas adultas, también con alta precisión (CV < 1%).

Rivera:
Tiene un total estimado menor (85.000), pero con mayor incertidumbre relativa (CV de 1.5%), aunque sigue siendo aceptable"
```

